{% extends "users/dashboard/dean_dashboard_layout.html" %}
<!-- ----------------------------- -->
{% block title %} Manage Courses {% endblock %}
<!-- ----------------------------- -->
{% block content %}

<div class="max-w-5xl mx-auto px-4 py-6 space-y-10">
  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-semibold text-gray-800">Manage Base Courses</h2>
    <button
      onclick="openCreateCourse()"
      class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer"
    >
      Add Course
    </button>
  </div>

  <!-- ============================= -->
  <!--        COURSE TABLE           -->
  <!-- ============================= -->
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4"
  >
    <!-- SEARCH BOX -->
    <input
      type="text"
      id="courseSearch"
      placeholder="Search courses..."
      class="w-full md:w-1/3 border border-gray-300 rounded-md px-3 py-2"
    />

    <!-- FILTER BY PROGRAM -->
    <select
      id="programFilter"
      class="w-full md:w-1/4 border border-gray-300 rounded-md px-3 py-2"
    >
      <option value="">Filter by Program</option>
      {% for p in programs %}
      <option value="{{ p.name }}">{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- ----------------------------------- -->
  <div class="bg-white border border-gray-200 rounded-lg">
    <table class="min-w-full text-sm divide-y divide-gray-200">
      <thead class="bg-gray-50 text-left">
        <tr>
          <th class="px-4 py-2 text-gray-600">Code</th>
          <th class="px-4 py-2 text-gray-600">Title</th>
          <th class="px-4 py-2 text-gray-600">Program</th>
          <th class="px-4 py-2 text-gray-600">Lecturers</th>
          <th class="px-4 py-2 text-gray-600">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100">
        {% for c in courses %}
        <tr
          class="course-row"
          data-code="{{ c.code|lower }}"
          data-title="{{ c.title|lower }}"
          data-program="{{ c.program.name|lower }}"
          data-lecturers="{% for l in c.assigned_lecturers.all %}{{ l.get_full_name|lower }} {% endfor %}"
        >
          <td class="px-4 py-2">{{ c.code }}</td>
          <td class="px-4 py-2">{{ c.title }}</td>
          <td class="px-4 py-2">{{ c.program.name }}</td>

          <!-- LECTURERS -->
          <td class="px-4 py-2">
            {% if c.assigned_lecturers.exists %}
            <!-- ----------------------------- -->
            {% for lect in c.assigned_lecturers.all %}
            <span
              class="inline-block text-xs px-2 py-1 rounded-md border border-gray-200 mr-1"
            >
              {{ lect.get_full_name }}
            </span>
            {% endfor %} {% else %}
            <span class="text-gray-500 text-sm">None</span>
            {% endif %}
          </td>

          <td class="px-4 py-2 space-x-3">
            <!-- FIXED EDIT BUTTON -->
            <button
              class="text-blue-600 hover:underline edit-course-btn"
              data-id="{{ c.id }}"
              data-title="{{ c.title|escapejs }}"
              data-code="{{ c.code|escapejs }}"
              data-description="{{ c.description|default:''|escapejs }}"
              data-credits="{{ c.credit_hours }}"
              data-program="{{ c.program.id }}"
              data-lecturers="{% for l in c.assigned_lecturers.all %}{{ l.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
            >
              Edit
            </button>

            <!-- DELETE BUTTON -->
            <button
              onclick="openDeleteCourse('{{ c.id }}')"
              class="text-red-600 hover:underline"
            >
              Delete
            </button>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-4 text-gray-500 text-center">
            No courses found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ====================================== -->
<!--           CREATE COURSE MODAL          -->
<!-- ====================================== -->
<div
  id="createCourseModal"
  class="hidden fixed inset-0 flex items-center justify-center"
  style="backdrop-filter: blur(6px); background-color: rgba(255, 255, 255, 0.3)"
>
  <div class="w-[600px] mx-auto bg-white rounded-lg border border-gray-200 p-6">
    <h3 class="text-lg font-medium mb-4">Create Course</h3>

    <form method="POST" class="w-full mx-auto">
      {% csrf_token %}
      <input type="hidden" name="create_course" value="1" />
      <div class="flex items-center gap-4">
        <div class="w-full">
          <!-- Program -->
          <label class="block mb-1 text-gray-700">Program</label>
          <select
            name="program_id"
            required
            id="programSelect"
            class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
          >
            <option value="">-- Select Program --</option>
            {% for p in programs %}
            <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Title -->
      <label class="block mb-1 text-gray-700">Course Title</label>
      <input
        name="title"
        required
        class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
      />

      <!-- Description -->
      <label class="block mb-1 text-gray-700">Description</label>
      <textarea
        name="description"
        rows="3"
        class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
      ></textarea>
      <div class="flex items-center gap-4">
        <!-- <div class="w-full">
          <label class="block mb-1">Course Code</label>
          <input
            name="code"
            required
            class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
          />
        </div> -->

        <div class="w-full">
          <!-- Credit Hours -->
          <label class="block mb-1 text-gray-700">Credit Hours</label>
          <input
            name="credit_hours"
            type="number"
            class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
            value="3"
          />
        </div>
      </div>

      <!-- Lecturers -->
      <label class="block mb-1 text-gray-700">Assign Lecturers</label>
      <select
        name="lecturer_ids"
        multiple
        class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3 h-24"
      >
        {% for l in lecturers %}
        <option value="{{ l.id }}">{{ l.get_full_name }}</option>
        {% endfor %}
      </select>

      <!-- Buttons -->
      <div class="flex justify-end space-x-2">
        <button
          type="button"
          onclick="closeCreateCourse()"
          class="px-4 py-2 border border-gray-200 rounded-md cursor-pointer"
        >
          Cancel
        </button>
        <button
          class="bg-blue-600 text-white px-4 py-2 rounded-md cursor-pointer"
        >
          Create
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ====================================== -->
<!--               EDIT MODAL               -->
<!-- ====================================== -->
<div
  id="editCourseModal"
  class="hidden fixed inset-0 flex items-center justify-center"
  style="backdrop-filter: blur(6px); background-color: rgba(255, 255, 255, 0.3)"
>
  <div class="w-[600px] mx-auto bg-white rounded-lg border border-gray-200 p-6">
    <h3 class="text-lg font-medium mb-4">Edit Course</h3>

    <form method="POST" class="w-full mx-auto">
      {% csrf_token %}
      <input type="hidden" name="update_course" value="1" />
      <input type="hidden" name="course_id" id="editCourseId" />

      <div class="flex items-center gap-4">
        <div class="w-full">
          <!-- Program -->
          <label class="block mb-1">Program</label>
          <select
            name="program_id"
            id="editProgram"
            class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
          >
            {% for p in programs %}
            <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Title -->
      <label class="block mb-1">Title</label>
      <input
        name="title"
        id="editTitle"
        class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
      />

      <!-- Description -->
      <label class="block mb-1">Description</label>
      <textarea
        name="description"
        id="editDescription"
        rows="3"
        class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
      ></textarea>

      <div class="flex items-center gap-4">
        <div class="w-full">
          <!-- Code -->
          <label class="block mb-1">Code</label>
          <input
            name="code"
            id="editCode"
            class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
          />
        </div>
        <div class="w-full">
          <!-- Credit Hours -->
          <label class="block mb-1">Credit Hours</label>
          <input
            type="number"
            name="credit_hours"
            id="editCredits"
            class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3"
          />
        </div>
      </div>

      <!-- Lecturers -->
      <label class="block mb-1">Lecturers</label>
      <select
        name="lecturer_ids"
        id="editLecturers"
        multiple
        class="w-full border border-gray-200 rounded-md px-3 py-2 mb-3 h-24"
      >
        {% for l in lecturers %}
        <option value="{{ l.id }}">{{ l.get_full_name }}</option>
        {% endfor %}
      </select>

      <!-- Buttons -->
      <div class="flex justify-end space-x-2">
        <button
          type="button"
          onclick="closeEditCourse()"
          class="px-4 py-2 border border-gray-200 rounded-md"
        >
          Cancel
        </button>
        <button class="bg-blue-600 text-white px-4 py-2 rounded-md">
          Update
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ====================================== -->
<!--             DELETE MODAL              -->
<!-- ====================================== -->
<div
  id="deleteCourseModal"
  class="hidden fixed inset-0 flex items-center justify-center"
  style="backdrop-filter: blur(6px); background-color: rgba(255, 255, 255, 0.3)"
>
  <div class="bg-white rounded-lg border p-6 w-96">
    <h3 class="text-lg font-medium text-red-600 mb-4">Delete Course</h3>
    <p class="mb-4">Are you sure you want to delete this course?</p>

    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="delete_course" value="1" />
      <input type="hidden" name="course_id" id="deleteCourseId" />

      <div class="flex justify-end space-x-2">
        <button
          type="button"
          onclick="closeDeleteCourse()"
          class="px-4 py-2 border rounded-md"
        >
          Cancel
        </button>
        <button class="bg-red-600 text-white px-4 py-2 rounded-md">
          Delete
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ====================================== -->
<!--           JAVASCRIPT HANDLERS         -->
<!-- ====================================== -->
<script>
  const searchInput = document.getElementById("courseSearch");
  const programFilter = document.getElementById("programFilter");
  const rows = document.querySelectorAll(".course-row");

  function filterCourses() {
    const searchValue = searchInput.value.toLowerCase();
    const programValue = programFilter.value.toLowerCase();

    rows.forEach((row) => {
      const code = row.dataset.code;
      const title = row.dataset.title;
      const program = row.dataset.program;
      const lecturers = row.dataset.lecturers;

      const matchesSearch =
        code.includes(searchValue) ||
        title.includes(searchValue) ||
        program.includes(searchValue) ||
        lecturers.includes(searchValue);

      const matchesProgram = !programValue || program === programValue;

      if (matchesSearch && matchesProgram) {
        row.classList.remove("hidden");
      } else {
        row.classList.add("hidden");
      }
    });
  }

  searchInput.addEventListener("input", filterCourses);
  programFilter.addEventListener("change", filterCourses);

  /* -------------------- CREATE -------------------- */

  function openCreateCourse() {
    document.getElementById("createCourseModal").classList.remove("hidden");
  }

  function closeCreateCourse() {
    document.getElementById("createCourseModal").classList.add("hidden");
  }

  /* -------------------- EDIT -------------------- */
  document.querySelectorAll(".edit-course-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const d = this.dataset;

      document.getElementById("editCourseId").value = d.id;
      document.getElementById("editTitle").value = d.title;
      document.getElementById("editCode").value = d.code;
      document.getElementById("editDescription").value = d.description;
      document.getElementById("editCredits").value = d.credits;
      document.getElementById("editProgram").value = d.program;

      const lectArr = d.lecturers ? d.lecturers.split(",") : [];
      const lectSelect = document.getElementById("editLecturers");

      for (let opt of lectSelect.options) {
        opt.selected = lectArr.includes(opt.value);
      }

      document.getElementById("editCourseModal").classList.remove("hidden");
    });
  });

  function closeEditCourse() {
    document.getElementById("editCourseModal").classList.add("hidden");
  }

  /* -------------------- DELETE -------------------- */
  function openDeleteCourse(id) {
    document.getElementById("deleteCourseId").value = id;
    document.getElementById("deleteCourseModal").classList.remove("hidden");
  }

  function closeDeleteCourse() {
    document.getElementById("deleteCourseModal").classList.add("hidden");
  }
</script>

{% endblock %}
