{% extends "users/dashboard/dean_dashboard_layout.html" %}
{% block title %}Program Courses{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
  
  <!-- PAGE HEADER -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold">Program Courses</h2>

    <button 
      onclick="openDuplicateModal()"
      class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer">
      Duplicate Course →
    </button>
  </div>

  <!-- FILTER FORM -->
  <form method="GET" class="flex gap-3 items-center mb-5">

    <input type="text" name="q" value="{{ q }}" placeholder="Search..."
           class="border-c px-3 py-2 rounded w-1/3" />

    <select name="program_id" class="border-c px-3 py-2 rounded">
      <option value="">All Programs</option>
      {% for p in programs %}
        <option value="{{ p.id }}" {% if selected_program == p.id %}selected{% endif %}>
          {{ p.name }}
        </option>
      {% endfor %}
    </select>

    <select name="level_id" class="border-c px-3 py-2 rounded">
      <option value="">All Levels</option>
      {% for lvl in levels %}
        <option value="{{ lvl.id }}" {% if selected_level == lvl.id %}selected{% endif %}>
          {{ lvl.program.name }} — {{ lvl.level_name }}
        </option>
      {% endfor %}
    </select>

    <select name="semester_id" class="border-c px-3 py-2 rounded">
      <option value="">All Semesters</option>
      {% for s in semesters %}
        <option value="{{ s.id }}" {% if selected_semester == s.id %}selected{% endif %}>
          {{ s.name }} ({{ s.academic_year.name }})
        </option>
      {% endfor %}
    </select>

    <button class="px-4 py-2 bg-blue-600 text-white rounded cursor-pointer">Apply</button>
  </form>


  <!-- PROGRAM COURSE TABLE -->
  <div class="bg-white border-c rounded">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr class="text-left">
          <th class="px-3 py-2">Code</th>
          <th class="px-3 py-2">Title</th>
          <th class="px-3 py-2">Program</th>
          <th class="px-3 py-2">Level</th>
          <th class="px-3 py-2">Semester</th>
          <th class="px-3 py-2">Lecturers</th>
          <th class="px-3 py-2">Status</th>
          <th class="px-3 py-2">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for pc in page_obj %}
        <tr class="border-t border-gray-100">
          <td class="px-3 py-2 font-medium">{{ pc.course_code }}</td>
          <td class="px-3 py-2">{{ pc.title }}</td>
          <td class="px-3 py-2">
            {{ pc.program.name }}
          </td>
          <td class="px-3 py-2">{{ pc.level.level_name }}</td>

          <td class="px-3 py-2">
            {% if pc.semester %}
              {{ pc.semester.name }}
            {% else %}
              -
            {% endif %}
          </td>

          <td class="">   <!-- LECTURERS -->
          <div class="px-4 py-2 text-xs">
            {% if pc.assigned_lecturers.exists %}
            <!-- ----------------------------- -->
            {% for lect in pc.assigned_lecturers.all %}
            <span
              class="inline-block text-xs px-2 py-1 rounded-md border border-gray-200 mr-1"
            >
              {{ lect.get_full_name }}
            </span>
            {% endfor %} 
            <!-- ------------ -->
            {% else %}
            <span class="text-gray-500 text-sm">None</span>
            {% endif %}
        </div>
    </td>
          <td class="px-3 py-2 text-xs">{{ pc.is_active|yesno:"Active,Locked" }}</td>

          <td class="px-3 py-2">
            <button onclick="openEditProgramCourse('{{ pc.id }}')"
                    class="text-blue-600 hover:underline text-xs cursor-pointer">
              Edit
            </button>
            <button class="text-red-600 hover:underline text-xs ml-3 cursor-pointer"
        onclick="openDeleteProgramCourse('{{ pc.id }}', '{{ pc.title|escapejs }}')">
        Delete
    </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  <!-- PAGINATION -->
  {% if page_obj.has_other_pages %}
  <div class="mt-4 flex gap-2">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 border-c rounded">Prev</a>
    {% endif %}

    <span class="px-3 py-1">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 border-c rounded">Next</a>
    {% endif %}
  </div>
  {% endif %}


</div>


<!-- ============================ -->
<!-- EDIT MODAL -->
<!-- ============================ -->
<div id="editProgramCourseModal"
     class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">

  <div class="bg-white rounded-lg w-[500px] p-6 shadow-xl">
    <h3 class="text-lg font-semibold mb-4">Edit Course Mapping</h3>

    <form id="editProgramCourseForm" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="pc_id" id="pc_id">
      
      <div class="w-full">
          <label class="text-sm text-gray-600">Course Title</label>
          <input id="pc_title" name="pc_title" class="w-full border px-3 py-2 rounded" required>
      </div>

      <div class="w-full">
          <label class="mt-3 text-sm text-gray-600">Course Code</label>
          <input id="pc_code" class="w-full border px-3 py-2 rounded bg-gray-100" disabled>
      </div>

      <div class="w-full">
          <label class="mt-3 text-sm text-gray-600">Credit hours</label>
          <input id="pc_credit" name="pc_credit" class="w-full border px-3 py-2 rounded">
      </div>

      <!-- <div class=""> -->
          <label class="flex items-center space-x-2 my-4 text-sm text-gray-600">
             <input type="hidden" name="is_active" value="false">
              <input type="checkbox" id="pc_active" name="is_active" class="border-c px-3 py-2 rounded mr-2" value="true">
            Course Active
          </label>
      <!-- </div> -->

      <div class="w-full">
          <label class="mt-3 text-sm text-gray-600">Assigned Lecturers</label>
          <select name="lecturers" id="pc_lecturers" multiple
                  class="w-full border px-3 py-2 rounded h-28">
            {% for l in lecturers %}
              <option value="{{ l.id }}">{{ l.get_full_name }}</option>
            {% endfor %}
          </select>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="closeEditProgramCourse()" class="px-4 py-2 border-c rounded cursor-pointer">
          Cancel
        </button>

        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded cursor-pointer">
          Save
        </button>
      </div>
    </form>
  </div>
</div>


<!-- DELETE MODAL -->
<div id="deleteProgramCourseModal"
     class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">

  <div class="bg-white rounded-lg w-[400px] p-6 shadow-xl">
    <h3 class="text-lg font-semibold text-red-600 mb-4">Delete Course Mapping</h3>

    <p id="deleteMessage" class="text-gray-700 mb-4"></p>

    <input type="hidden" id="delete_pc_id">

    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteProgramCourse()"
              class="px-4 py-2 border-c rounded cursor-pointer">
        Cancel
      </button>

      <button onclick="confirmDeleteProgramCourse()"
              class="px-4 py-2 bg-red-600 text-white rounded cursor-pointer">
        Delete
      </button>
    </div>
  </div>
</div>



<!-- ============================ -->
<!-- DUPLICATE MODAL -->
<!-- ============================ -->
<div id="duplicateModal"
     class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">

  <div class="bg-white rounded-lg w-[600px] p-6 shadow-xl">
    <h3 class="text-lg font-semibold mb-4">Duplicate Course to Program</h3>

    <div id="dupMessage" class="hidden mb-3 p-3 rounded text-sm mt-2 mb-2"></div>

    <form id="duplicateForm">
      {% csrf_token %}

      <!-- Program -->
      <label class="block text-sm mb-1">Program</label>
      <select id="dup_program" name="program_id"
              class="w-full border-c px-3 py-2 rounded mb-3" required>
        <option value="">-- Select Program --</option>
        {% for p in programs %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>

      <!-- Level (Loaded dynamically) -->
      <label class="block text-sm mb-1">Level</label>
      <select id="dup_level" name="level_id"
              class="w-full border-c px-3 py-2 rounded mb-3" required>
        <option value="">-- Select Program First --</option>
      </select>

      <!-- Semester (Loaded dynamically based on level) -->
      <label class="block text-sm mb-1">Semester</label>
      <select id="dup_semester" name="semester_id"
              class="w-full border-c px-3 py-2 rounded mb-3" required>
        <option value="">-- Select Level First --</option>
      </select>

      <!-- Base Courses (Loaded dynamically based on program) -->
      <label class="block text-sm mb-1">Choose Base Course</label>
      <select id="dup_base_course" name="base_course_id"
              class="w-full border-c px-3 py-2 rounded mb-3" required>
        <option value="">-- Select Program First --</option>
      </select>

      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="closeDuplicateModal()"
                class="px-4 py-2 border-c rounded cursor-pointer">Cancel</button>

        <button type="submit"
                class="px-4 py-2 bg-green-600 text-white rounded cursor-pointer">
          Duplicate
        </button>
      </div>
    </form>
  </div>
</div>



<!-- ============================ -->
<!-- JAVASCRIPT -->
<!-- ============================ -->
<script>

/* ------------------------------
   OPEN / CLOSE MODAL
--------------------------------*/
function openDuplicateModal() {
    document.getElementById("duplicateModal").classList.remove("hidden");
}

function closeDuplicateModal() {
    document.getElementById("duplicateModal").classList.add("hidden");
}

/* ------------------------------
   AJAX: Load Levels & Base Courses
--------------------------------*/
document.getElementById("dup_program").addEventListener("change", function () {
    const programId = this.value;

    // Reset fields
    document.getElementById("dup_level").innerHTML =
        `<option>Loading levels...</option>`;
    document.getElementById("dup_base_course").innerHTML =
        `<option>Loading courses...</option>`;
    document.getElementById("dup_semester").innerHTML =
        `<option>Select level first</option>`;

    fetch(`/users/dean/ajax/program-levels-courses/${programId}/`)
        .then(res => res.json())
        .then(data => {
            /* Populate Levels */
            const lvlSel = document.getElementById("dup_level");
            lvlSel.innerHTML = `<option value="">-- Select Level --</option>`;
            data.levels.forEach(l =>
                lvlSel.innerHTML += `<option value="${l.id}">${l.name}</option>`
            );

            /* Populate Base Courses */
            const courseSel = document.getElementById("dup_base_course");
            courseSel.innerHTML = `<option value="">-- Select Base Course --</option>`;
            data.courses.forEach(c =>
                courseSel.innerHTML += `<option value="${c.id}">${c.title} (${c.code})</option>`
            );
        });
});

/* ------------------------------
   AJAX: Load Semesters when Level Selected
--------------------------------*/
document.getElementById("dup_level").addEventListener("change", function () {
    const levelId = this.value;

    const semesterSel = document.getElementById("dup_semester");
    semesterSel.innerHTML = `<option>Loading semesters...</option>`;

    fetch(`/users/dean/ajax/level-semesters/${levelId}/`)
        .then(res => res.json())
        .then(data => {
            semesterSel.innerHTML = `<option value="">-- Optional --</option>`;
            data.semesters.forEach(s =>
                semesterSel.innerHTML += `<option value="${s.id}">${s.name}</option>`
            );
        });
});

/* ------------------------------
   AJAX: Duplicate Course
--------------------------------*/
document.getElementById("duplicateForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch(`/users/dean/program-course/duplicate/`, {
        method: "POST",
        headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        const box = document.getElementById("dupMessage");

        // Show the message box
        box.classList.remove("hidden");

        if (data.success) {
            // SUCCESS MESSAGE
            box.className = "mb-3 p-3 rounded text-sm bg-green-100 text-green-800";
            box.innerText = data.message || "Course duplicated successfully.";

            setTimeout(() => {
                closeDuplicateModal();
                location.reload(); // reload table after success
            }, 1200);
        }
        else if (data.exists) {
            // DUPLICATE WARNING
            box.className = "mb-3 p-3 rounded text-sm bg-yellow-100 text-yellow-800";
            box.innerText = data.message || "This course already exists.";
        }
        else if (data.error) {
            // ERROR MESSAGE
            box.className = "mb-3 p-3 rounded text-sm bg-red-100 text-red-800";
            box.innerText = data.error;
        }
    })
    .catch(() => {
        const box = document.getElementById("dupMessage");
        box.className = "mb-3 p-3 rounded text-sm bg-red-100 text-red-800";
        box.innerText = "An unexpected error occurred.";
        box.classList.remove("hidden");
    });
});

/* ------------------------------
   DELETE PROGRAM COURSE
--------------------------------*/

function openDeleteProgramCourse(id, title) {
    document.getElementById("delete_pc_id").value = id;
    document.getElementById("deleteMessage").innerText =
        `Are you sure you want to delete the course "${title}"?`;
    document.getElementById("deleteProgramCourseModal").classList.remove("hidden");
}

function closeDeleteProgramCourse() {
    document.getElementById("deleteProgramCourseModal").classList.add("hidden");
}

function confirmDeleteProgramCourse() {
    const pcId = document.getElementById("delete_pc_id").value;

    fetch(`/users/dean/program-course/delete/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ id: pcId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeDeleteProgramCourse();
            location.reload(); 
        } else {
            alert(data.error || "Delete failed");
        }
    });
}



function openEditProgramCourse(id) {
  fetch(`/users/dean/program-course/${id}/json/`)
    .then(res => res.json())
    .then(data => {
        document.getElementById("pc_id").value = data.id;
        document.getElementById("pc_title").value = data.title;
        document.getElementById("pc_code").value = data.code;
        document.getElementById("pc_credit").value = data.credit_hours;
        document.getElementById("pc_active").checked = data.active;

        const lecturerSelect = document.getElementById("pc_lecturers");
        [...lecturerSelect.options].forEach(opt => {
            opt.selected = data.lecturer_ids.includes(parseInt(opt.value));
        });

        document.getElementById("editProgramCourseModal").classList.remove("hidden");
    });
}

function closeEditProgramCourse() {
  document.getElementById("editProgramCourseModal").classList.add("hidden");
}

document.getElementById("editProgramCourseForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch(`/users/dean/program-course/update/`, {
        method: "POST",
        headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") },
        body: formData,
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeEditProgramCourse();
            location.reload();
        } else {
            alert(data.error || "Update failed");
        }
    });
});



</script>

{% endblock %}
