{% extends "users/dashboard/admin_dashboard_layout.html" %} {% block title %}
Academic Transition {% endblock %} {% load static %} {% block content %}
<div class="max-w-5xl mx-auto p-6">
  <h1 class="text-2xl font-semibold mb-6">Academic Transition</h1>

  <!-- ======================= TABS ======================= -->
  <div class="mb-6 border-b border-gray-300">
    <nav class="-mb-px flex gap-4" aria-label="Tabs">
      <!-- SYSTEM LOCK TAB -->
      <a
        id="tab-lock"
        class="px-3 py-2 cursor-pointer border-b-2 border-transparent"
        onclick="showTab('lock')"
      >
        System Lock
      </a>

      <!-- TRANSITION TAB ONLY IF LOCKED -->
      {% if system_lock.is_locked %}
      <a
        id="tab-transition"
        class="px-3 py-2 cursor-pointer border-b-2 border-transparent"
        onclick="showTab('transition')"
      >
        Transition Students
      </a>
      {% endif %}
    </nav>
  </div>

  <!-- ======================= LOCK TAB CONTENT ======================= -->
  <div id="tab-content-lock" class="hidden">
    <div class="bg-white p-4 rounded shadow-sm">
      <h3 class="text-lg font-medium mb-4">System Lock</h3>

      {% if system_lock.is_locked %}
      <p class="text-red-600 font-semibold mb-3">
        ⚠ The system is currently LOCKED.
      </p>
      {% else %}
      <p class="text-green-700 font-semibold mb-3">
        ✓ System is currently UNLOCKED.
      </p>
      {% endif %}

      <form method="POST" action="{% url 'portal:toggle_system_lock' %}">
        {% csrf_token %} {% if system_lock.is_locked %}
        <button
          name="action"
          value="unlock"
          class="bg-green-600 text-white px-4 py-2 rounded"
        >
          Unlock System
        </button>
        {% else %}
        <button
          name="action"
          value="lock"
          class="bg-red-600 text-white px-4 py-2 rounded"
        >
          Lock System
        </button>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- ======================= TRANSITION TAB CONTENT ======================= -->
  {% if system_lock.is_locked %}
  <div id="tab-content-transition" class="hidden">
    <div class="bg-white p-4 rounded shadow-sm">
      <p class="mb-4 text-sm text-gray-600">
        Select the program to transition. Ensure a 'Ready' academic year and an
        active semester exist for the next level before proceeding.
      </p>

      <form id="transition-form" method="POST" onsubmit="return false;">
        {% csrf_token %}

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Program</label>
          <select
            id="program-select"
            name="program_id"
            class="border px-3 py-2 w-full"
          >
            <option value="">-- select program --</option>
            {% for p in programs %}
            <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>

        <button
          type="button"
          class="bg-blue-600 text-white px-4 py-2 rounded"
          onclick="openConfirm()"
        >
          Go
        </button>
      </form>

      <!-- ======================= CONFIRM MODAL ======================= -->
      <div
        id="confirm-modal"
        class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded w-3/5">
          <h3 class="text-lg font-semibold mb-3">
            Proceed Transition — Warning
          </h3>
          <p class="mb-4">
            This action will create new program courses, promote students to the
            next level, deactivate old courses, and switch academic years.<br />
            <strong>This action is irreversible.</strong>
          </p>

          <div class="flex justify-end gap-3">
            <button class="px-4 py-2 border rounded" onclick="closeConfirm()">
              Cancel
            </button>
            <button
              class="px-4 py-2 bg-red-600 text-white rounded"
              onclick="startTransition()"
            >
              Proceed Transition with Caution
            </button>
          </div>
        </div>
      </div>

      <!-- ======================= PROGRESS MODAL ======================= -->
      <div
        id="progress-modal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded w-3/5 max-h-[80vh] overflow-auto">
          <h3 class="text-lg font-semibold mb-3">Transition in progress</h3>

          <div
            id="progress-log"
            class="text-sm font-mono whitespace-pre-wrap text-gray-800 h-64 overflow-auto border rounded p-3 bg-gray-50"
          ></div>

          <div class="flex justify-end mt-4">
            <button
              id="progress-close"
              class="px-4 py-2 border rounded hidden"
              onclick="closeProgress()"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ======================= JS ======================= -->
  <script>
    // Default tab
    const systemLocked =
      "{{ system_lock.is_locked|yesno:'true,false' }}" === "true";
    showTab(systemLocked ? "transition" : "lock");

    function showTab(tab) {
      // Hide all
      document.getElementById("tab-content-lock").classList.add("hidden");
      const transTab = document.getElementById("tab-content-transition");
      if (transTab) transTab.classList.add("hidden");

      // Remove highlights
      document
        .getElementById("tab-lock")
        .classList.remove("border-blue-600", "text-blue-600");
      const transBtn = document.getElementById("tab-transition");
      if (transBtn)
        transBtn.classList.remove("border-blue-600", "text-blue-600");

      // Activate selected tab
      if (tab === "lock") {
        document.getElementById("tab-content-lock").classList.remove("hidden");
        document
          .getElementById("tab-lock")
          .classList.add("border-blue-600", "text-blue-600");
      } else {
        if (transTab) {
          transTab.classList.remove("hidden");
          transBtn.classList.add("border-blue-600", "text-blue-600");
        }
      }
    }

    function openConfirm() {
      const locked =
        "{{ system_lock.is_locked|yesno:'true,false' }}" === "true";
      if (!locked) {
        alert("You must LOCK the system first.");
        return;
      }
      if (!document.getElementById("program-select").value) {
        alert("Select a program.");
        return;
      }
      document.getElementById("confirm-modal").classList.remove("hidden");
    }

    function closeConfirm() {
      document.getElementById("confirm-modal").classList.add("hidden");
    }

    function openProgress() {
      document.getElementById("progress-log").innerText =
        "Starting transition...\n";
      document.getElementById("progress-modal").classList.remove("hidden");
      document.getElementById("progress-close").classList.add("hidden");
    }

    function closeProgress() {
      document.getElementById("progress-modal").classList.add("hidden");
    }

    async function startTransition() {
      closeConfirm();

      openProgress();
      const logNode = document.getElementById("progress-log");
      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      const programId = document.getElementById("program-select").value;

      try {
        const resp = await fetch("/academics/admin/transition/start/", {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          body: new URLSearchParams({ program_id: programId }),
        });

        const json = await resp.json();

        if (!json.success) {
          logNode.innerText += `\nERROR: ${json.error}\n`;
          document.getElementById("progress-close").classList.remove("hidden");
          return;
        }

        json.logs.forEach((line) => (logNode.innerText += line + "\n"));

        logNode.innerText += "\n----- SUMMARY -----\n";
        logNode.innerText += `New Courses: ${json.created_count}\n`;
        logNode.innerText += `Deactivated Courses: ${json.deactivated_count}\n`;
        logNode.innerText += `Students Promoted: ${json.promoted_count}\n`;

        document.getElementById("progress-close").classList.remove("hidden");
      } catch (err) {
        logNode.innerText += `\nCRITICAL ERROR: ${err.message}\n`;
        document.getElementById("progress-close").classList.remove("hidden");
      }
    }
  </script>
</div>
{% endblock %}
