{% extends "users/dashboard/student_dashboard_layout.html" %}
<!-- =============================== -->
{% block title %} Student Dashboard {% endblock %}
<!-- =============================== -->
{% block content %}
<div class="max-w-6xl mx-auto px-4">
  <div class="container mx-auto">
    <h1 class="text-3xl font-bold text-gray-800">
      Welcome, {{ user.first_name }}! üëã
    </h1>
    <p class="text-sm pl-1 pt-1 mb-8 text-gray-500">{{user.program}} ‚ñ™Ô∏è {{user.level.level_name}}</p>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">

  <!-- ===================== -->
  <!-- CURRENT GPA CARD -->
  <!-- ===================== -->
  <div class="bg-white p-6 rounded-3xl border-2 border-slate-200 shadow-card flex items-center justify-between">

    <div>
      <div class="text-slate-400 text-xs font-extrabold uppercase mb-1">
        Current CGPA
      </div>

      <div class="text-4xl font-extrabold text-slate-800">
        {{ current_gpa|default:"-" }}
      </div>

      <div class="mt-2 text-green-500 text-xs font-bold flex items-center">
        <i data-lucide="trending-up" class="w-3 h-3 mr-1 stroke-[3]"></i>
        On track
      </div>
    </div>

    <div class="w-16 h-16 rounded-full border-4 border-slate-100 border-t-brand-500 flex items-center justify-center">
      <span class="font-extrabold text-brand-600 text-lg">
        {% if current_gpa %}
          {{ current_gpa|stringformat:".1f"|slice:":1" }}
        {% else %}
          -
        {% endif %}
      </span>
    </div>

  </div>

  <!-- ===================== -->
  <!-- TOTAL CREDITS CARD -->
  <!-- ===================== -->
  <div class="bg-white p-6 rounded-3xl border-2 border-slate-200 shadow-card flex items-center justify-between">

    <div>
      <div class="text-slate-400 text-xs font-extrabold uppercase mb-1">
        Credits Earned
      </div>

      <div class="text-4xl font-extrabold text-slate-800">
        {{ total_credits|default:"0" }}
        <span class="text-slate-300 text-2xl">
          /{{ max_credits|default:"120" }}
        </span>
      </div>

      <div class="text-slate-400 text-xs font-bold mt-2">
        Progress toward graduation
      </div>
    </div>

    <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600">
      <i data-lucide="book-open" class="w-7 h-7 stroke-[2.5]"></i>
    </div>

  </div>

  <!-- ===================== -->
  <!-- FEE BALANCE CARD -->
  <!-- ===================== -->
  <div class="bg-white p-6 rounded-3xl border-2 border-slate-200 shadow-card flex items-center justify-between">

    <div>
      <div class="text-slate-400 text-xs font-extrabold uppercase mb-1">
        Fee Balance
      </div>

      <div class="text-4xl font-extrabold text-slate-800">
        {{ fee_balance|default:"0.00" }}
      </div>

      {% if fee_balance|floatformat:2 == "0.00" %}
        <div class="mt-2 text-green-500 text-xs font-bold flex items-center bg-green-50 px-2 py-1 rounded-lg w-fit">
          <i data-lucide="check-circle-2" class="w-3 h-3 mr-1 stroke-[3]"></i>
          Cleared
        </div>
      {% else %}
        <div class="mt-2 text-red-500 text-xs font-bold flex items-center bg-red-50 px-2 py-1 rounded-lg w-fit">
          <i data-lucide="alert-circle" class="w-3 h-3 mr-1 stroke-[3]"></i>
          Outstanding
        </div>
      {% endif %}
    </div>

    <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center text-green-600">
      <i data-lucide="credit-card" class="w-7 h-7 stroke-[2.5]"></i>
    </div>

  </div>

</div>


    <!-- GPA PROGRESSION BASED ON GRADE POINTS -->
   
    <div class="bg-white p-6 rounded-3xl border-2 border-slate-200 mt-8">
   <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Performance Trend</h3>

        <!-- Semester Filter -->
       <form method="GET" class="flex items-center gap-2 flex-shrink min-w-0">
            <select 
                name="semester" 
                id="semesterSelect" 
                class="border-c rounded-md px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-gray-200"
            >
                {% for s in graph_semesters %}
                <option value="{{ s.id }}" {% if selected_sem_id == s.id %}selected{% endif %}>
                    {{ s.name }} - {{ s.academic_year.name }}
                </option>
                {% endfor %}
            </select>
            <button class="bg-brand-500 border-b-4 border-brand-700 text-white px-4 py-2 rounded text-xs shrink-0">
                Load
            </button>
        </form>
    </div>

    <div class="chart w-full min-w-0" style="height: 320px;">
        <canvas id="performanceChart"></canvas>
    </div>
   </div>


  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const labels = JSON.parse(`{{ course_labels|escapejs }}`);
    const gradePoints = JSON.parse(`{{ grade_points|escapejs }}`);

    const ctx = document.getElementById("performanceChart").getContext("2d");

    let gradient = ctx.createLinearGradient(0, 0, 0, 260);
    gradient.addColorStop(0, "rgba(37, 99, 235, 0.45)");
    gradient.addColorStop(1, "rgba(37, 99, 235, 0.08)");

    function calculateTrend(data) {
        if (data.length <= 1) return data;
        let n = data.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        for (let i = 0; i < n; i++) {
            sumX += i;
            sumY += data[i];
            sumXY += i * data[i];
            sumXX += i * i;
        }
        const slope = (n * sumXY - sumX * sumY) /
                      (n * sumXX - sumX * sumX || 1);
        const intercept = (sumY - slope * sumX) / n;
        return Array.from({ length: n }, (_, i) => slope * i + intercept);
    }

    const trendLine = calculateTrend(gradePoints);

    new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Grade Point",
                    data: gradePoints,
                    backgroundColor: gradient,
                    borderColor: "#2563eb",
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: "#2563eb",
                    pointBorderColor: "#fff",
                },
                {
                    label: "Trend Line",
                    data: trendLine,
                    borderColor: "#1f2937",
                    borderDash: [5, 4],
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0,
                },
            ],
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
        }
    });

});
</script>

<style>
  /* let flex children shrink properly */
.chart.min-w-0, .chart-wrapper, .w-full.min-w-0 {
  min-width: 0 !important;
}

/* ensure canvas respects parent width */
#performanceChart {
  width: 100% !important;
  height: 100% !important;
  display: block;
}
</style>

{% endblock %}


