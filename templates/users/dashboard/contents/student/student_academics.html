{% extends "users/dashboard/student_dashboard_layout.html" %}
{% block title %}My Academics{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto px-4 py-8 space-y-6">

  <!-- ================= HEADER AREA ================= -->
  <div class="w-full flex items-center justify-between">
      <div class="w-full">

          <div class="flex items-center gap-4">
              <h1 class="text-2xl font-bold text-gray-800">Academic Record</h1>

              <!-- Academic Year Switcher -->
              <form method="GET" class="flex items-center space-x-2">
                  <!-- <label class="text-sm text-gray-600"></label> -->
                  <select name="year" id="yearSelect" class="border-c rounded-md px-2 py-2 text-xs">
                    {% for y in all_years %}
                    <option value="{{ y.id }}" 
                        {% if selected_year_id|stringformat:"s" == y.id|stringformat:"s" %}
                            selected
                        {% endif %}
                    >
                        {{ y.name }}
                    </option>
                    {% endfor %}
                </select>
              </form>
          </div>

          <div class="w-full flex items-center justify-between">

            <!-- Show selected academic year -->
            <p class="text-sm text-gray-500 mt-2">
                Current Academic Year breakdown of your courses, scores and grades: 
                <strong class="text-xs">{{ selected_year.name }}</strong>
            </p>
  
            <!-- CGPA Display -->
            <div class="flex justify-between items-center mt-1">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center gap-2 text-right">
                        <div class="text-xs text-gray-500">Current CGPA</div>
                        <div class="text-3xl font-extrabold text-indigo-700">
                            {% if cgpa %}{{ cgpa }}{% else %}—{% endif %}
                        </div>
                    </div>
                </div>
            </div>
          </div>

      </div>
  </div>

  <!-- ================= NO DATA MESSAGE ================= -->
  {% if not semesters %}
  <div class="bg-white border border-gray-200 rounded-lg p-6 text-center text-gray-600">
      No assessments found for academic year <strong>{{ selected_year.name }}</strong>.
  </div>
  {% else %}

  <!-- ================= SEMESTER CARDS ================= -->
  <div class="grid gap-6 md:grid-cols-1">

      {% for sem_key, data in semesters.items %}
      {% with sem=data.semester %}

      <article class="bg-white border border-gray-200 rounded-lg shadow-sm">

          <!-- COLLAPSIBLE HEADER -->
          <header
              class="px-5 py-4 flex items-center justify-between cursor-pointer semester-toggle border-b border-gray-200"
              data-target="sem-{{ sem.id }}"
          >
              <div class="flex items-center gap-3">
                  <div class="text-sm text-gray-500">{{ sem.academic_year.name }}</div>
                  <div class="text-lg font-semibold text-gray-800">{{ sem.name }}</div>
              </div>

              <div class="flex items-center gap-2 text-right">
                  <div class="text-xs text-gray-500">Semester GPA</div>
                  <div class="text-lg font-bold text-indigo-600">
                      {{ data.gpa|default:"—" }}
                  </div>
              </div>
          </header>

          <!-- COLLAPSIBLE CONTENT -->
          <div id="sem-{{ sem.id }}" class="hidden px-5 pb-5">
              <div class="overflow-x-auto">
                  <table class="w-full text-sm table-auto">
                      <thead class="bg-gray-100 py-1">
                          <tr class="text-left text-xs text-gray-600">
                              <th class="px-3 py-2">Course</th>
                              <th class="px-3 py-2">Title</th>
                              <th class="px-3 py-2">Score</th>
                              <th class="px-3 py-2">Grade</th>
                              <th class="px-3 py-2">Recorded</th>
                              <th class="px-3 py-2">Lecturer</th>
                          </tr>
                      </thead>

                      <tbody class="divide-y divide-gray-100">
                          {% for a in data.courses %}
                          <tr>
                              <td class="px-3 py-3 font-medium text-gray-800">
                                  {{ a.course.course_code }}
                              </td>
                              <td class="px-3 py-3 text-gray-700">
                                  {{ a.course.title }}
                              </td>
                              <td class="px-3 py-3 font-semibold">
                                  {{ a.score }}
                              </td>
                              <td class="px-3 py-3">
                                  <span class="px-2 py-1 rounded-md text-xs font-semibold bg-gray-100 text-gray-800">
                                      {{ a.grade }}
                                  </span>
                              </td>
                              <td class="px-3 py-3 text-gray-500 text-xs">
                                  {{ a.date_recorded|date:"Y-m-d" }}
                              </td>
                              <td class="px-3 py-3 text-gray-600 text-sm">
                                  {% if a.recorded_by %}
                                      {{ a.recorded_by.get_full_name }}
                                  {% else %}
                                      —
                                  {% endif %}
                              </td>
                          </tr>
                          {% empty %}
                          <tr>
                              <td colspan="6" class="px-3 py-4 text-center text-gray-500">
                                  No course records for this semester.
                              </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>

              <!-- FOOTER -->
              <div class="mt-4 flex justify-end items-center">
                  <div class="text-xs text-gray-500 mr-3">
                      Courses:
                      <span class="font-medium text-gray-700">
                          {{ data.courses|length }}
                      </span>
                  </div>

                  <button
                      onclick="toggleCollapse('sem-{{ sem.id }}')"
                      class="text-sm text-indigo-600 hover:underline"
                  >
                      Close
                  </button>
              </div>
          </div>

      </article>

      {% endwith %}
      {% endfor %}
  </div>

  {% endif %}
</div>

<!-- PRINT BUTTON -->
<div class="flex justify-end p-6">
  <button
    onclick="window.print()"
    class="ml-auto inline-flex items-center px-6 py-2 bg-gray-800 text-white rounded-md text-sm hover:opacity-95"
  >
    Print
  </button>
</div>


<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    // Auto-submit year switcher
    const yearSelect = document.getElementById("yearSelect");
    if (yearSelect) {
        yearSelect.addEventListener("change", function () {
            this.form.submit();
        });
    }

    // Collapsible semesters
    document.querySelectorAll(".semester-toggle").forEach(function (el) {
        el.addEventListener("click", function () {
            var targetId = this.dataset.target;
            toggleCollapse(targetId);
        });
    });
});

function toggleCollapse(id) {
    var el = document.getElementById(id);
    if (!el) return;

    if (el.classList.contains("hidden")) {
        el.classList.remove("hidden");
        el.scrollIntoView({ behavior: "smooth", block: "start" });
    } else {
        el.classList.add("hidden");
    }
}
</script>


<!-- PRINT STYLES -->
<style>
@media print {
    body * {
        visibility: hidden;
    }
    .max-w-6xl,
    .max-w-6xl * {
        visibility: visible;
    }
    .max-w-6xl {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .semester-toggle {
        cursor: default;
    }
}
</style>

{% endblock %}
