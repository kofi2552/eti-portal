{% extends "users/dashboard/student_dashboard_layout.html" %}
{% block title %}My Academics{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto px-4 py-8 space-y-10">

  <!-- HEADER -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-slate-800">Academic Results</h1>
      <p class="text-slate-500 text-sm font-medium">
        Detailed assessment and GPA breakdown
      </p>
    </div>

    <form method="GET">
      <select
        name="year"
        id="yearSelect"
        class="border-2 border-slate-200 rounded-xl px-3 py-2 font-bold"
      >
        {% for y in all_years %}
        <option value="{{ y.id }}" {% if selected_year_id == y.id|stringformat:"s" %}selected{% endif %}>
          {{ y.name }}
        </option>
        {% endfor %}
      </select>
    </form>
  </div>

  {% if not semesters %}
    <div class="bg-white border-2 border-slate-200 rounded-3xl p-8 text-center">
      No academic records found for this academic year.
    </div>
  {% endif %}

  {% for sem_id, sem_data in semesters.items %}
  {% with sem=sem_data.semester %}

  <article class="bg-white border-2 border-slate-200 rounded-3xl overflow-hidden">

    <!-- SEMESTER HEADER (ACCORDION TOGGLE) -->
    <header
      class="px-6 py-5 flex justify-between bg-slate-50 border-b-2 cursor-pointer semester-toggle"
      data-target="sem-{{ sem.id }}"
    >
      <div>
        <h2 class="text-lg font-extrabold">{{ sem.name }}</h2>
        <p class="text-sm text-slate-400">{{ sem.academic_year.name }}</p>
      </div>
      <div class="text-right">
        <div class="text-xs text-slate-400 font-bold uppercase">GPA</div>
        <div class="text-xl font-extrabold text-brand-600">
          {{ sem_data.gpa|default:"—" }}
        </div>
      </div>
    </header>

    <!-- SEMESTER BODY -->
    <div id="sem-{{ sem.id }}" class="hidden px-6 py-6 space-y-8">

      {% if not sem_data.courses %}
        <div class="text-center text-slate-400 text-sm py-6">
          No assessment records available for this semester.
        </div>
      {% endif %}

      {% for course_id, cdata in sem_data.courses.items %}
      {% with c=cdata.course %}

      <section class="border-2 border-slate-100 rounded-2xl p-5">
        <h3 class="text-lg font-extrabold mb-3">
          {{ c.course_code }} — {{ c.title }}
        </h3>

        <!-- TASKS -->
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b text-xs text-slate-400 uppercase">
              <th class="text-left py-2">Task</th>
              <th class="text-left py-2">Assessment</th>
              <th class="text-right py-2">Score</th>
              <th class="text-right py-2">Grade</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for t in cdata.tasks %}
            <tr>
              <td class="py-2">
                {{ t.title }}
              </td>

              <td class="py-2">
                <span class="px-2 py-1 text-xs font-bold rounded bg-slate-100 text-slate-700">
                  {{ t.category|title }} · {{ t.type }}
                </span>
              </td>

              <td class="py-2 text-right font-semibold">
                {{ t.marks }} / {{ t.total }}
              </td>

              <td class="py-2 text-right font-extrabold">
                {{ t.grade }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      {% endwith %}
      {% endfor %}

      <!-- SEMESTER SUMMARY -->
      <div class="mt-6 border-t-2 border-slate-200 pt-4 grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">

        <div>
          <div class="text-xs font-extrabold uppercase text-slate-400">
            Internal
          </div>
          <div class="font-extrabold text-slate-700">
            {{ sem_data.internal_total }}
          </div>
        </div>

        <div>
          <div class="text-xs font-extrabold uppercase text-slate-400">
            External
          </div>
          <div class="font-extrabold text-slate-700">
            {{ sem_data.external_total }}
          </div>
        </div>

        <div>
          <div class="text-xs font-extrabold uppercase text-slate-400">
            Total Score
          </div>
          <div class="font-extrabold text-slate-800">
            {{ sem_data.overall_score }}
          </div>
        </div>

        <div>
          <div class="text-xs font-extrabold uppercase text-slate-400">
            Overall Grade
          </div>
          <div class="font-extrabold text-brand-600">
            {{ sem_data.overall_grade }}
          </div>
        </div>

        <div>
          <div class="text-xs font-extrabold uppercase text-slate-400">
            Total Credits
          </div>
          <div class="font-extrabold text-slate-700">
            {{ sem_data.total_credits }}
          </div>
        </div>

      </div>

    </div>
  </article>

  {% endwith %}
  {% endfor %}
</div>

<!-- JS -->
<script>
document.getElementById("yearSelect")?.addEventListener("change", function () {
  this.form.submit();
});

document.querySelectorAll(".semester-toggle").forEach(el => {
  el.addEventListener("click", () => {
    const target = document.getElementById(el.dataset.target);
    if (target) {
      target.classList.toggle("hidden");
    }
  });
});
</script>

{% endblock %}
